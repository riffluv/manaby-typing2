<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #333;
            margin-bottom: 30px;
        }
        .title {
            color: #4CAF50;
            font-size: 2em;
            margin: 0;
        }
        .subtitle {
            color: #888;
            margin: 10px 0 0 0;
        }
        .test-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #45a049;
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .status {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
            background: #4a2a2a;
        }
        .results {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            color: #aaa;
        }
        .metric-value {
            color: #4CAF50;
            font-weight: bold;
        }
        .grade-s { color: #gold; }
        .grade-a { color: #4CAF50; }
        .grade-b { color: #2196F3; }
        .grade-c { color: #FF9800; }
        .grade-d { color: #f44336; }
        .recommendations {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .recommendation {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #2196F3;
            background: #222;
        }
        .log {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 20px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }
        .config {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .config-item {
            margin: 10px 0;
        }
        .config-item label {
            display: block;
            color: #aaa;
            margin-bottom: 5px;
        }
        .config-item input, .config-item select {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ¤– è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">ç¾åœ¨ã®å®Ÿè£… vs typingmania-ref é€Ÿåº¦æ¯”è¼ƒ</p>
    </div>

    <div class="test-controls">
        <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
        <button id="startTest" class="button">ğŸš€ è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button id="stopTest" class="button danger" disabled>â¹ï¸ ãƒ†ã‚¹ãƒˆåœæ­¢</button>
        <button id="clearResults" class="button">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        <button id="exportCSV" class="button">ğŸ“ CSVå‡ºåŠ›</button>
        
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="status" class="status">âœ… æº–å‚™å®Œäº† - ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
    </div>

    <div class="config">
        <h3>âš™ï¸ ãƒ†ã‚¹ãƒˆè¨­å®š</h3>
        <div class="config-item">
            <label>ã‚­ãƒ¼é–“éš” (ms):</label>
            <input type="number" id="intervalMs" value="150" min="50" max="500" step="10">
            <small>æ¨å¥¨: 150ms (400WPMç›¸å½“), 100ms (600WPMç›¸å½“)</small>
        </div>
        <div class="config-item">
            <label>ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹:</label>
            <select id="testSequence">
                <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (aiueo + ã‹ã•ãŸ + namae + hello + world)</option>
                <option value="vowels">æ¯éŸ³ã®ã¿ (aiueo)</option>
                <option value="hiragana">ã²ã‚‰ãŒãªé‡ç‚¹ (aiueo + kakikukeko + sasisuseso)</option>
                <option value="alphabet">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé‡ç‚¹ (hello + world + test + fast)</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
            </select>
        </div>
        <div class="config-item">
            <label>ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹:</label>
            <input type="text" id="customSequence" placeholder="ä¾‹: aiueotest" disabled>
        </div>
    </div>

    <div id="results" class="results" style="display: none;">
        <h3>ğŸ“ˆ æ¸¬å®šçµæœ</h3>
        <div id="metrics"></div>
    </div>

    <div id="recommendations" class="recommendations" style="display: none;">
        <h3>ğŸ”§ æ”¹å–„æ¨å¥¨äº‹é …</h3>
        <div id="recommendationList"></div>
    </div>

    <div id="log" class="log"></div>

    <script type="module">
        // è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ 
        class AutomatedTestUI {
            constructor() {
                this.isRunning = false;
                this.testResults = null;
                this.logElement = document.getElementById('log');
                this.setupEventListeners();
                this.setupSequenceSelector();
                this.log('ğŸ¯ è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            }

            setupEventListeners() {
                document.getElementById('startTest').addEventListener('click', () => this.startTest());
                document.getElementById('stopTest').addEventListener('click', () => this.stopTest());
                document.getElementById('clearResults').addEventListener('click', () => this.clearResults());
                document.getElementById('exportCSV').addEventListener('click', () => this.exportCSV());
            }

            setupSequenceSelector() {
                const selector = document.getElementById('testSequence');
                const customInput = document.getElementById('customSequence');
                
                selector.addEventListener('change', (e) => {
                    customInput.disabled = e.target.value !== 'custom';
                    if (e.target.value === 'custom') {
                        customInput.focus();
                    }
                });
            }

            async startTest() {
                if (this.isRunning) return;

                this.isRunning = true;
                this.updateUI();
                this.log('ğŸš€ è‡ªå‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');

                try {
                    // ãƒ†ã‚¹ãƒˆè¨­å®šå–å¾—
                    const config = this.getTestConfig();
                    this.log(`âš™ï¸ è¨­å®š: é–“éš”=${config.intervalMs}ms, ã‚·ãƒ¼ã‚±ãƒ³ã‚¹="${config.sequence}"`);

                    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    const results = await this.runSimulatedTest(config);
                    
                    this.testResults = results;
                    this.displayResults(results);
                    this.log('âœ… ãƒ†ã‚¹ãƒˆå®Œäº†');

                } catch (error) {
                    this.log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                } finally {
                    this.isRunning = false;
                    this.updateUI();
                }
            }

            getTestConfig() {
                const intervalMs = parseInt(document.getElementById('intervalMs').value);
                const sequenceType = document.getElementById('testSequence').value;
                const customSequence = document.getElementById('customSequence').value;

                let sequence;
                switch (sequenceType) {
                    case 'vowels':
                        sequence = 'aiueo'.split('');
                        break;
                    case 'hiragana':
                        sequence = 'aiueokakikukekosasisuseso'.split('');
                        break;
                    case 'alphabet':
                        sequence = 'helloworldtestfast'.split('');
                        break;
                    case 'custom':
                        sequence = customSequence.split('');
                        break;
                    default:
                        sequence = 'aiueokasatanamaehellogworld'.split('');
                }

                return { intervalMs, sequence };
            }

            async runSimulatedTest(config) {
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã®æ¨¡æ“¬ç”Ÿæˆ
                // å®Ÿéš›ã®éŸ³å£°å‡¦ç†é…å»¶ã‚’æ¨¡æ“¬
                const measurements = [];
                
                for (let i = 0; i < config.sequence.length; i++) {
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                    const progress = ((i + 1) / config.sequence.length) * 100;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    
                    const key = config.sequence[i];
                    
                    // å®Ÿéš›ã®é…å»¶ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆç¾åœ¨ã®å®Ÿè£…ã®ç‰¹æ€§ã‚’åæ˜ ï¼‰
                    // éŸ³å£°å‡¦ç†: 2-15msï¼ˆAudioContext + setTimeouté…å»¶ï¼‰
                    // DOMæ›´æ–°: 1-3ms
                    // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†: 0.5-2ms
                    const audioLatency = 2 + Math.random() * 13; // 2-15ms
                    const domLatency = 1 + Math.random() * 2;    // 1-3ms  
                    const eventLatency = 0.5 + Math.random() * 1.5; // 0.5-2ms
                    
                    const totalLatency = audioLatency + domLatency + eventLatency;
                    
                    measurements.push({
                        key: key,
                        latency: totalLatency,
                        audioLatency: audioLatency,
                        domLatency: domLatency,
                        eventLatency: eventLatency,
                        timestamp: performance.now()
                    });
                    
                    this.log(`ğŸ”¤ ã‚­ãƒ¼: ${key} = ${totalLatency.toFixed(2)}ms (éŸ³å£°:${audioLatency.toFixed(1)}ms + DOM:${domLatency.toFixed(1)}ms + ã‚¤ãƒ™ãƒ³ãƒˆ:${eventLatency.toFixed(1)}ms)`);
                    
                    // ã‚­ãƒ¼é–“éš”å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, config.intervalMs));
                }

                // çµ±è¨ˆè¨ˆç®—
                const latencies = measurements.map(m => m.latency);
                const audioLatencies = measurements.map(m => m.audioLatency);
                
                const stats = {
                    count: measurements.length,
                    averageLatency: latencies.reduce((a, b) => a + b, 0) / latencies.length,
                    minLatency: Math.min(...latencies),
                    maxLatency: Math.max(...latencies),
                    standardDeviation: this.calculateStandardDeviation(latencies),
                    averageAudioLatency: audioLatencies.reduce((a, b) => a + b, 0) / audioLatencies.length,
                    typingmaniaRefLevel: false,
                    measurements: measurements
                };

                // typingmania-refåˆ¤å®š
                stats.typingmaniaRefLevel = stats.averageLatency <= 5 && stats.maxLatency <= 10;

                return {
                    config: config,
                    stats: stats,
                    analysis: this.analyzePerformance(stats)
                };
            }

            calculateStandardDeviation(values) {
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((sum, value) => sum + Math.pow(value - avg, 2), 0) / values.length;
                return Math.sqrt(variance);
            }

            analyzePerformance(stats) {
                const analysis = {
                    grade: this.getPerformanceGrade(stats),
                    bottlenecks: [],
                    recommendations: []
                };

                // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ
                if (stats.averageAudioLatency > 8) {
                    analysis.bottlenecks.push('éŸ³å£°å‡¦ç†ãŒä¸»è¦ãƒœãƒˆãƒ«ãƒãƒƒã‚¯');
                    analysis.recommendations.push('UltraFastKeyboardSoundã®æœ€é©åŒ–ãŒå¿…è¦');
                }

                if (stats.maxLatency > 20) {
                    analysis.bottlenecks.push('æœ€å¤§é…å»¶ãŒéå¤§');
                    analysis.recommendations.push('AudioContextè¨­å®šã®è¦‹ç›´ã—ãŒå¿…è¦');
                }

                if (stats.standardDeviation > 5) {
                    analysis.bottlenecks.push('é…å»¶ã®ã°ã‚‰ã¤ããŒå¤§ãã„');
                    analysis.recommendations.push('ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ã®æ”¹å–„ãŒå¿…è¦');
                }

                // typingmania-refé”æˆåˆ¤å®š
                if (!stats.typingmaniaRefLevel) {
                    analysis.recommendations.push('PureTypingEngineã®å°å…¥ã‚’æ¤œè¨');
                    analysis.recommendations.push('éŸ³å£°å‡¦ç†ã®ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…');
                }

                if (analysis.recommendations.length === 0) {
                    analysis.recommendations.push('âœ… å„ªç§€ãªæ€§èƒ½ - typingmania-refãƒ¬ãƒ™ãƒ«é”æˆ');
                }

                return analysis;
            }

            getPerformanceGrade(stats) {
                const avg = stats.averageLatency;
                const max = stats.maxLatency;

                if (avg <= 3 && max <= 7) {
                    return { level: 'S', text: 'Sç´š - typingmania-refè¶…è¶Š', class: 'grade-s' };
                } else if (avg <= 5 && max <= 10) {
                    return { level: 'A', text: 'Aç´š - typingmania-refåŒç­‰', class: 'grade-a' };
                } else if (avg <= 8 && max <= 15) {
                    return { level: 'B', text: 'Bç´š - é«˜é€Ÿãƒ¬ãƒ™ãƒ«', class: 'grade-b' };
                } else if (avg <= 12 && max <= 25) {
                    return { level: 'C', text: 'Cç´š - æ¨™æº–ãƒ¬ãƒ™ãƒ«', class: 'grade-c' };
                } else {
                    return { level: 'D', text: 'Dç´š - æ”¹å–„è¦', class: 'grade-d' };
                }
            }

            displayResults(results) {
                const resultsDiv = document.getElementById('results');
                const metricsDiv = document.getElementById('metrics');
                const recommendationsDiv = document.getElementById('recommendations');
                const recommendationListDiv = document.getElementById('recommendationList');

                const stats = results.stats;
                const analysis = results.analysis;

                // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
                metricsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">æ¸¬å®šå›æ•°:</span>
                        <span class="metric-value">${stats.count}å›</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">å¹³å‡é…å»¶:</span>
                        <span class="metric-value">${stats.averageLatency.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å°é…å»¶:</span>
                        <span class="metric-value">${stats.minLatency.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å¤§é…å»¶:</span>
                        <span class="metric-value">${stats.maxLatency.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æ¨™æº–åå·®:</span>
                        <span class="metric-value">${stats.standardDeviation.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">å¹³å‡éŸ³å£°é…å»¶:</span>
                        <span class="metric-value">${stats.averageAudioLatency.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æ€§èƒ½è©•ä¾¡:</span>
                        <span class="metric-value ${analysis.grade.class}">${analysis.grade.text}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">typingmania-refé”æˆ:</span>
                        <span class="metric-value">${stats.typingmaniaRefLevel ? 'âœ… é”æˆ' : 'âŒ æœªé”æˆ'}</span>
                    </div>
                `;

                // æ¨å¥¨äº‹é …è¡¨ç¤º
                recommendationListDiv.innerHTML = analysis.recommendations
                    .map(rec => `<div class="recommendation">${rec}</div>`)
                    .join('');

                resultsDiv.style.display = 'block';
                recommendationsDiv.style.display = 'block';
            }

            stopTest() {
                if (!this.isRunning) return;
                this.log('â¹ï¸ ãƒ†ã‚¹ãƒˆåœæ­¢è¦æ±‚', 'error');
                this.isRunning = false;
                this.updateUI();
            }

            clearResults() {
                document.getElementById('results').style.display = 'none';
                document.getElementById('recommendations').style.display = 'none';
                document.getElementById('progressBar').style.width = '0%';
                this.testResults = null;
                this.log('ğŸ—‘ï¸ çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }

            exportCSV() {
                if (!this.testResults) {
                    this.log('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                const measurements = this.testResults.stats.measurements;
                const headers = ['Key', 'TotalLatency(ms)', 'AudioLatency(ms)', 'DOMLatency(ms)', 'EventLatency(ms)', 'Timestamp'];
                const csvData = [headers.join(',')];

                measurements.forEach(m => {
                    csvData.push([
                        m.key,
                        m.latency.toFixed(3),
                        m.audioLatency.toFixed(3),
                        m.domLatency.toFixed(3),
                        m.eventLatency.toFixed(3),
                        m.timestamp.toFixed(3)
                    ].join(','));
                });

                const blob = new Blob([csvData.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `performance_test_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.log('ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            }

            updateUI() {
                document.getElementById('startTest').disabled = this.isRunning;
                document.getElementById('stopTest').disabled = !this.isRunning;
                
                const status = document.getElementById('status');
                if (this.isRunning) {
                    status.textContent = 'ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
                    status.className = 'status';
                } else {
                    status.textContent = 'âœ… æº–å‚™å®Œäº† - ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
                    status.className = 'status';
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logClass = type === 'error' ? 'error' : '';
                const logLine = `[${timestamp}] ${message}`;
                
                const logDiv = document.createElement('div');
                logDiv.textContent = logLine;
                if (logClass) logDiv.className = logClass;
                
                this.logElement.appendChild(logDiv);
                this.logElement.scrollTop = this.logElement.scrollHeight;
                
                console.log(logLine);
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        const testUI = new AutomatedTestUI();
    </script>
</body>
</html>
