<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音声なし vs 音声ありパフォーマンス比較</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .typing-area {
      font-size: 1.4rem;
      line-height: 2;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 4px;
      margin: 10px 0;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }
    
    .typing-char {
      display: inline-block;
      transition: none;
      padding: 2px;
      margin: 1px;
    }
    
    .typing-char.pending {
      color: #888;
      background: transparent;
    }
    
    .typing-char.current {
      color: #ffffff;
      background: #0066cc;
      border-radius: 3px;
      box-shadow: 0 0 8px rgba(0, 102, 204, 0.5);
    }
    
    .typing-char.completed {
      color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    .typing-char.error {
      color: #f44336;
      background: rgba(244, 67, 54, 0.2);
    }
    
    .performance-display {
      background: #0d1b2a;
      border: 1px solid #1b4f72;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    
    .stat-item {
      background: #333;
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: #bbb;
      display: block;
    }
    
    .stat-value {
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
    }
    
    .stat-value.good {
      color: #4CAF50;
    }
    
    .stat-value.warning {
      color: #ff9800;
    }
    
    .stat-value.bad {
      color: #f44336;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    button.start {
      background: #4CAF50;
    }
    
    button.start:hover {
      background: #45a049;
    }
    
    button.reset {
      background: #ff9800;
    }
    
    button.reset:hover {
      background: #f57c00;
    }
    
    .comparison-result {
      background: #2d5016;
      border: 1px solid #4caf50;
      border-radius: 4px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .warning {
      background: #5d4037;
      border: 1px solid #ff9800;
      color: #ffcc02;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .word-display {
      font-size: 1.2rem;
      color: #64b5f6;
      margin: 10px 0;
      padding: 12px;
      background: #1e3a8a;
      border-radius: 4px;
      text-align: center;
    }
    
    .current-test {
      border: 2px solid #4CAF50;
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }
    
    .improvement {
      background: #1b5e20;
      border: 1px solid #4caf50;
      color: #a5d6a7;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      font-size: 1.1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 音声処理パフォーマンス比較テスト</h1>
    <p>音声なしエンジン vs 現在の実装（音声あり）の速度差を測定</p>
    
    <!-- 音声なしテスト -->
    <div class="test-section" id="silent-section">
      <h2>🔇 音声なし高速エンジン (ベースライン)</h2>
      <div class="word-display" id="silent-word-display">準備中...</div>
      <div class="typing-area" id="silent-typing-area"></div>
      <div class="performance-display" id="silent-performance">測定待機中</div>
      <div class="controls">
        <button class="start" onclick="startSilentTest()">音声なしテスト開始</button>
        <button class="reset" onclick="resetSilentTest()">リセット</button>
        <button onclick="simulateSilentTyping()">自動入力テスト</button>
      </div>
    </div>
    
    <!-- 音声ありテスト（現在の実装参照） -->
    <div class="test-section" id="audio-section">
      <h2>🔊 音声あり実装 (現在の実装)</h2>
      <div class="warning">
        <strong>注意:</strong> このテストでは、現在の実装（http://localhost:3001/game）での測定結果と比較します。<br>
        実際のテストは別タブでタイピングゲームを実行して手動で測定してください。
      </div>
      <div class="controls">
        <button onclick="openCurrentImplementation()">現在の実装を開く</button>
        <button onclick="inputAudioResults()">音声あり結果を入力</button>
      </div>
    </div>
    
    <!-- 比較結果 -->
    <div class="test-section">
      <h2>📊 パフォーマンス比較結果</h2>
      <div id="comparison-result" class="warning">
        まず音声なしテストを実行してください
      </div>
      <div class="controls">
        <button onclick="generateDetailedReport()">詳細レポート生成</button>
        <button onclick="exportComparisonResults()">結果をエクスポート</button>
      </div>
    </div>
  </div>

  <script type="module">
    // 音声なし高速エンジン（インライン実装）
    class SilentTypingEngine {
      constructor() {
        this.container = null;
        this.chars = [];
        this.currentIndex = 0;
        this.keyHandler = null;
        this.measurements = [];
        this.recording = false;
        this.setupKeyHandler();
      }

      setContainer(container) {
        this.container = container;
      }

      setWord(hiragana) {
        const romajiMap = {
          'こ': 'ko', 'ん': 'n', 'に': 'ni', 'ち': 'ti', 'は': 'ha',
          'あ': 'a', 'り': 'ri', 'が': 'ga', 'と': 'to', 'う': 'u',
          'お': 'o', 'つ': 'tu', 'か': 'ka', 'れ': 're', 'さ': 'sa', 'ま': 'ma',
          'ば': 'ba', 'っ': 'tta', 'て': 'te', 'よ': 'yo', 'し': 'si', 'く': 'ku'
        };

        this.chars = [];
        for (let char of hiragana) {
          if (romajiMap[char]) {
            this.chars.push({
              kana: char,
              romaji: romajiMap[char],
              inputted: '',
              completed: false
            });
          }
        }
        this.currentIndex = 0;
        this.render();
      }

      setupKeyHandler() {
        this.keyHandler = (e) => {
          if (e.key.length !== 1 || !/[a-z]/.test(e.key)) return;
          
          const startTime = performance.now();
          
          // 純粋なタイピング処理（音声・エフェクトなし）
          const result = this.processKey(e.key);
          this.render();
          
          const endTime = performance.now();
          const latency = endTime - startTime;
          
          if (this.recording) {
            this.measurements.push(latency);
            this.updatePerformanceDisplay();
          }
          
          e.preventDefault();
        };

        document.addEventListener('keydown', this.keyHandler);
      }

      processKey(key) {
        if (this.currentIndex >= this.chars.length) return 'completed';

        const currentChar = this.chars[this.currentIndex];
        const expectedChar = currentChar.romaji[currentChar.inputted.length];

        if (key === expectedChar) {
          currentChar.inputted += key;
          if (currentChar.inputted === currentChar.romaji) {
            currentChar.completed = true;
            this.currentIndex++;
          }
          return 'correct';
        } else {
          return 'error';
        }
      }

      render() {
        if (!this.container) return;

        const html = this.chars.map((char, index) => {
          let displayChars = '';
          for (let i = 0; i < char.romaji.length; i++) {
            const romChar = char.romaji[i];
            let className = 'typing-char ';

            if (i < char.inputted.length) {
              className += 'completed';
            } else if (index === this.currentIndex && i === char.inputted.length) {
              className += 'current';
            } else {
              className += 'pending';
            }

            displayChars += `<span class="${className}">${romChar}</span>`;
          }
          return displayChars;
        }).join('');

        this.container.innerHTML = html;
      }

      updatePerformanceDisplay() {
        const stats = this.getStats();
        const element = document.getElementById('silent-performance');
        
        element.innerHTML = `
          <div class="stats">
            <div class="stat-item">
              <span class="stat-label">平均遅延</span>
              <span class="stat-value ${stats.avg <= 1 ? 'good' : stats.avg <= 3 ? 'warning' : 'bad'}">${stats.avg}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">最大遅延</span>
              <span class="stat-value ${stats.max <= 2 ? 'good' : stats.max <= 5 ? 'warning' : 'bad'}">${stats.max}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">最小遅延</span>
              <span class="stat-value">${stats.min}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">測定回数</span>
              <span class="stat-value">${stats.count}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">理想的性能</span>
              <span class="stat-value ${stats.ideal ? 'good' : 'warning'}">${stats.ideal ? '✅ 理想的' : '⚠️ 改善余地あり'}</span>
            </div>
          </div>
        `;
      }

      startRecording() {
        this.measurements = [];
        this.recording = true;
        console.log('🎯 音声なしタイピング測定開始');
      }

      stopRecording() {
        this.recording = false;
        return this.getStats();
      }

      getStats() {
        if (this.measurements.length === 0) {
          return { count: 0, avg: 0, min: 0, max: 0, ideal: false };
        }

        const avg = this.measurements.reduce((a, b) => a + b, 0) / this.measurements.length;
        const min = Math.min(...this.measurements);
        const max = Math.max(...this.measurements);
        // 音声なしなので、より厳しい基準（平均1ms以下、最大2ms以下）
        const ideal = avg <= 1 && max <= 2;

        return {
          count: this.measurements.length,
          avg: parseFloat(avg.toFixed(3)),
          min: parseFloat(min.toFixed(3)),
          max: parseFloat(max.toFixed(3)),
          ideal,
          measurements: [...this.measurements]
        };
      }

      isCompleted() {
        return this.currentIndex >= this.chars.length;
      }

      destroy() {
        if (this.keyHandler) {
          document.removeEventListener('keydown', this.keyHandler);
          this.keyHandler = null;
        }
      }

      reset() {
        this.currentIndex = 0;
        this.chars.forEach(char => {
          char.inputted = '';
          char.completed = false;
        });
        this.render();
      }
    }

    // グローバル変数
    let silentEngine = null;
    let silentResults = null;
    let audioResults = null;

    // テスト制御関数
    window.startSilentTest = function() {
      if (silentEngine) {
        silentEngine.destroy();
      }

      const container = document.getElementById('silent-typing-area');
      silentEngine = new SilentTypingEngine();
      silentEngine.setContainer(container);
      silentEngine.startRecording();

      document.getElementById('silent-word-display').textContent = '今日は (こんにちは)';
      silentEngine.setWord('こんにちは');
      
      document.getElementById('silent-performance').innerHTML = '<p>📊 測定中... タイピングを開始してください（音声なし）</p>';
      
      // 現在のテストセクションをハイライト
      document.getElementById('silent-section').classList.add('current-test');
      document.getElementById('audio-section').classList.remove('current-test');
    };

    window.resetSilentTest = function() {
      if (silentEngine) {
        silentEngine.destroy();
        silentEngine = null;
      }
      document.getElementById('silent-typing-area').innerHTML = '';
      document.getElementById('silent-performance').innerHTML = '測定待機中';
      document.getElementById('silent-word-display').textContent = '準備中...';
      document.getElementById('silent-section').classList.remove('current-test');
    };

    window.simulateSilentTyping = function() {
      if (!silentEngine) {
        startSilentTest();
        setTimeout(simulateSilentTyping, 100);
        return;
      }

      const keys = ['k', 'o', 'n', 'n', 'i', 't', 'i', 'h', 'a'];
      let keyIndex = 0;

      const simulate = () => {
        if (keyIndex >= keys.length || silentEngine.isCompleted()) {
          setTimeout(() => {
            silentResults = silentEngine.stopRecording();
            showSilentResults(silentResults);
          }, 500);
          return;
        }

        const key = keys[keyIndex];
        const event = new KeyboardEvent('keydown', {
          key: key,
          bubbles: true,
          cancelable: true
        });

        document.dispatchEvent(event);
        keyIndex++;

        setTimeout(simulate, 30 + Math.random() * 70); // 30-100msの間隔
      };

      setTimeout(simulate, 300);
    };

    function showSilentResults(results) {
      console.log('🔇 音声なしエンジン結果:', results);
      
      if (audioResults) {
        showComparison();
      } else {
        document.getElementById('comparison-result').innerHTML = `
          <h3>🔇 音声なし結果 (ベースライン)</h3>
          <p><strong>平均遅延:</strong> ${results.avg}ms</p>
          <p><strong>最大遅延:</strong> ${results.max}ms</p>
          <p><strong>最小遅延:</strong> ${results.min}ms</p>
          <p><strong>測定回数:</strong> ${results.count}回</p>
          <p>次に、現在の実装（音声あり）でテストを実行してください。</p>
        `;
      }
    }

    window.openCurrentImplementation = function() {
      window.open('http://localhost:3001/game', '_blank');
      alert('新しいタブで現在の実装が開きます。\n\nタイピングを実行してコンソールでパフォーマンス結果を確認してください。\n\n結果が得られたら「音声あり結果を入力」ボタンで入力してください。');
    };

    window.inputAudioResults = function() {
      const avgInput = prompt('音声ありの平均遅延 (ms) を入力してください:');
      const maxInput = prompt('音声ありの最大遅延 (ms) を入力してください:');
      const countInput = prompt('音声ありの測定回数を入力してください:');

      if (avgInput && maxInput && countInput) {
        audioResults = {
          avg: parseFloat(avgInput),
          max: parseFloat(maxInput),
          count: parseInt(countInput),
          typingmaniaRefLevel: parseFloat(avgInput) <= 5 && parseFloat(maxInput) <= 10
        };

        console.log('🔊 音声あり結果（手動入力）:', audioResults);

        if (silentResults) {
          showComparison();
        } else {
          alert('先に音声なしテストを実行してください。');
        }
      }
    };

    function showComparison() {
      if (!silentResults || !audioResults) return;

      const improvement = ((audioResults.avg - silentResults.avg) / audioResults.avg * 100);
      const maxImprovement = ((audioResults.max - silentResults.max) / audioResults.max * 100);

      let resultClass = 'comparison-result';
      let recommendation = '';

      if (improvement > 50) {
        recommendation = '🚀 音声処理が大幅な遅延を引き起こしています。音声システムの最適化または無効化を強く推奨します。';
      } else if (improvement > 20) {
        recommendation = '⚠️ 音声処理による遅延が確認されました。最適化を検討してください。';
      } else if (improvement > 0) {
        recommendation = '📊 軽微な遅延が音声処理で発生していますが、許容範囲内です。';
      } else {
        recommendation = '✅ 音声処理による遅延は検出されませんでした。';
      }

      document.getElementById('comparison-result').className = resultClass;
      document.getElementById('comparison-result').innerHTML = `
        <h3>📊 パフォーマンス比較結果</h3>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-label">音声なし平均</span>
            <span class="stat-value good">${silentResults.avg}ms</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">音声あり平均</span>
            <span class="stat-value ${audioResults.typingmaniaRefLevel ? 'warning' : 'bad'}">${audioResults.avg}ms</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">平均遅延改善</span>
            <span class="stat-value ${improvement > 20 ? 'good' : 'warning'}">${improvement.toFixed(1)}%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">最大遅延改善</span>
            <span class="stat-value ${maxImprovement > 20 ? 'good' : 'warning'}">${maxImprovement.toFixed(1)}%</span>
          </div>
        </div>
        <div class="improvement">
          ${recommendation}
        </div>
        <p><strong>結論:</strong> 音声処理を削除することで平均 ${improvement.toFixed(1)}% の速度向上が期待できます。</p>
      `;
    }

    window.generateDetailedReport = function() {
      const report = {
        timestamp: new Date().toISOString(),
        test: 'Audio Performance Impact Analysis',
        silent: silentResults,
        audio: audioResults,
        environment: {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          hardwareConcurrency: navigator.hardwareConcurrency
        }
      };

      console.log('📋 詳細パフォーマンス比較レポート:', report);
      alert('詳細レポートがコンソールに出力されました');
    };

    window.exportComparisonResults = function() {
      const data = {
        testType: 'Audio Performance Impact Test',
        timestamp: new Date().toISOString(),
        results: {
          silent: silentResults,
          audio: audioResults
        }
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'audio-performance-comparison.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    // 初期化
    window.addEventListener('load', () => {
      console.log('🚀 音声パフォーマンス比較テスト準備完了');
      document.getElementById('silent-word-display').textContent = 'テスト開始ボタンを押してください';
    });
  </script>
</body>
</html>
