<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「ん」パターン切り替えテスト</title>
    <style>
        body {
            font-family: 'MS Gothic', monospace;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-word {
            font-size: 24px;
            margin: 20px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .current-char {
            background-color: #ffeb3b;
            padding: 2px 4px;
        }
        .completed-char {
            background-color: #4caf50;
            color: white;
            padding: 2px 4px;
        }
        .remaining-char {
            background-color: #f5f5f5;
            padding: 2px 4px;
        }
        .romaji-display {
            font-size: 18px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .accepted {
            color: #4caf50;
            font-weight: bold;
        }
        .remaining {
            color: #666;
        }
        .stats {
            margin: 20px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>「ん」パターン切り替えテスト</h1>
        
        <p>以下の単語をタイピングして、「ん」の後の文字の入力で「nn」から「n」パターンに切り替わることを確認してください：</p>
        
        <div class="test-word">
            <span id="kana-display">プログラミング</span>
        </div>
        
        <div class="romaji-display">
            <span id="romaji-accepted"></span><span id="romaji-remaining"></span>
        </div>
        
        <div class="stats">
            <div>現在の文字: <span id="current-char">-</span></div>
            <div>入力済み: <span id="accepted-input">-</span></div>
            <div>残り: <span id="remaining-input">-</span></div>
            <div>パターン: <span id="current-patterns">-</span></div>
            <div>キー数: <span id="key-count">0</span></div>
            <div>ミス: <span id="miss-count">0</span></div>
        </div>

        <div>
            <h3>ログ:</h3>
            <div id="log" class="log"></div>
        </div>

        <div style="margin-top: 20px;">
            <button onclick="resetTest()">リセット</button>
            <button onclick="showPatterns()">パターン確認</button>
        </div>
    </div>

    <script type="module">
        // typingmania-refのlatin-tableを動的にインポート
        const latinTableModule = await import('./typingmania-ref/latin-table/latin-table.js');
        const latinTable = latinTableModule.default;

        class TypingChar {
            constructor(kana, patterns) {
                this.kana = kana;
                this.patterns = patterns.map(p => p.toLowerCase());
                this.acceptedInput = '';
                this.completed = false;
                this.basePoint = this.patterns[0]?.length || 0;
                this.countedPoint = 0;
                this.calculateRemainingText();
            }

            calculateRemainingText() {
                if (this.completed) {
                    this.remainingText = '';
                    return;
                }

                this.remainingText = this.patterns[this.patterns.length - 1] || '';
                
                for (const pattern of this.patterns) {
                    if (pattern.startsWith(this.acceptedInput)) {
                        const remaining = pattern.slice(this.acceptedInput.length);
                        if (remaining.length < this.remainingText.length) {
                            this.remainingText = remaining;
                        }
                    }
                }
            }

            type(char) {
                if (this.completed) return false;

                const lowerChar = char.toLowerCase();
                let progress = false;

                for (const pattern of this.patterns) {
                    if (pattern.startsWith(this.acceptedInput + lowerChar)) {
                        this.acceptedInput += lowerChar;
                        progress = true;
                        break;
                    }
                }

                if (progress) {
                    for (const pattern of this.patterns) {
                        if (pattern === this.acceptedInput) {
                            this.completed = true;
                            this.countedPoint = this.basePoint;
                            break;
                        }
                    }
                    this.calculateRemainingText();
                }

                return progress;
            }

            switchToSingleNPattern() {
                if (this.kana === 'ん' && this.acceptedInput === 'n') {
                    this.completed = true;
                    this.countedPoint = this.basePoint;
                    this.calculateRemainingText();
                }
            }

            switchToPattern(targetPattern) {
                if (this.patterns.includes(targetPattern)) {
                    this.patterns = [targetPattern, ...this.patterns.filter(p => p !== targetPattern)];
                    this.calculateRemainingText();
                }
            }

            reset() {
                this.acceptedInput = '';
                this.completed = false;
                this.countedPoint = 0;
                this.calculateRemainingText();
            }
        }

        // かなをTypingCharに変換
        function createTypingChars(text) {
            const chars = [];
            
            for (const kana of text) {
                const patterns = [];
                
                // latin-tableから該当するパターンを検索
                for (const entry of latinTable) {
                    if (entry[0] === kana) {
                        patterns.push(entry[1]);
                    }
                }
                
                if (patterns.length > 0) {
                    chars.push(new TypingChar(kana, patterns));
                } else {
                    // パターンが見つからない場合はそのまま追加
                    chars.push(new TypingChar(kana, [kana]));
                }
            }
            
            return chars;
        }

        // テストセットアップ
        let typingChars = createTypingChars('プログラミング');
        let currentIndex = 0;
        let keyCount = 0;
        let missCount = 0;
        const logElement = document.getElementById('log');

        function log(message) {
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateDisplay() {
            const currentChar = typingChars[currentIndex];
            if (!currentChar) {
                document.getElementById('current-char').textContent = '完了';
                document.getElementById('accepted-input').textContent = '-';
                document.getElementById('remaining-input').textContent = '-';
                document.getElementById('current-patterns').textContent = '-';
                document.getElementById('romaji-accepted').textContent = '';
                document.getElementById('romaji-remaining').textContent = '';
                return;
            }

            document.getElementById('current-char').textContent = currentChar.kana;
            document.getElementById('accepted-input').textContent = currentChar.acceptedInput || '(なし)';
            document.getElementById('remaining-input').textContent = currentChar.remainingText || '(なし)';
            document.getElementById('current-patterns').textContent = currentChar.patterns.join(', ');
            document.getElementById('key-count').textContent = keyCount;
            document.getElementById('miss-count').textContent = missCount;

            // ローマ字表示
            document.getElementById('romaji-accepted').textContent = currentChar.acceptedInput;
            document.getElementById('romaji-remaining').textContent = currentChar.remainingText;
        }

        function handleNCharacterLogic(key, currentChar) {
            if (currentChar.kana === 'ん' && 
                currentChar.patterns.includes('nn') && 
                currentChar.acceptedInput === 'n') {
                
                const nextChar = typingChars[currentIndex + 1];
                if (!nextChar) return false;

                for (const pattern of nextChar.patterns) {
                    if (pattern.startsWith(key.toLowerCase())) {
                        log(`「ん」パターン切り替え: 'nn' → 'n', 次の文字「${nextChar.kana}」パターン「${pattern}」`);
                        
                        currentChar.switchToSingleNPattern();
                        currentIndex++;
                        
                        nextChar.switchToPattern(pattern);
                        
                        const nextIsCorrect = nextChar.type(key);
                        if (nextIsCorrect) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function processKey(key) {
            keyCount++;
            
            const currentChar = typingChars[currentIndex];
            if (!currentChar) return;

            log(`入力: "${key}" | 現在の文字: "${currentChar.kana}" | 受付済み: "${currentChar.acceptedInput}"`);

            let isCorrect = handleNCharacterLogic(key, currentChar);
            
            if (!isCorrect) {
                isCorrect = currentChar.type(key);
            }

            if (isCorrect) {
                log(`✓ 正解`);
                
                if (currentChar.completed) {
                    log(`文字「${currentChar.kana}」完了`);
                    currentIndex++;
                    
                    if (currentIndex >= typingChars.length) {
                        log('★ 単語完了！');
                    }
                }
            } else {
                missCount++;
                log(`✗ ミス`);
            }

            updateDisplay();
        }

        // キーイベントリスナー
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.altKey || e.metaKey || e.key.length !== 1) {
                return;
            }
            e.preventDefault();
            processKey(e.key);
        });

        // 初期表示
        updateDisplay();
        log('テスト開始: 「プログラミング」を入力してください');
        log('「ん」の後の「ぐ」で「g」を入力すると「nn」→「n」に切り替わることを確認');

        // グローバル関数
        window.resetTest = function() {
            typingChars = createTypingChars('プログラミング');
            currentIndex = 0;
            keyCount = 0;
            missCount = 0;
            logElement.innerHTML = '';
            updateDisplay();
            log('リセット完了');
        };

        window.showPatterns = function() {
            log('=== 各文字のパターン ===');
            typingChars.forEach((char, i) => {
                log(`${char.kana}: [${char.patterns.join(', ')}]`);
            });
        };
    </script>
</body>
</html>
