<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperTypingEngine パフォーマンステスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .performance-stats {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #1976d2;
        }
        .test-results {
            font-family: monospace;
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .phase-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-weight: bold;
        }
        .phase-enabled { background: #4caf50; color: white; }
        .phase-disabled { background: #f44336; color: white; }
        .phase-loading { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <h1>🚀 HyperTypingEngine パフォーマンステスト</h1>
    
    <div class="test-container">
        <h2>現在の最適化状態</h2>
        <div id="optimization-status">
            <span class="phase-status phase-loading">Phase 1: 確認中...</span>
            <span class="phase-status phase-loading">Phase 2: 確認中...</span>
        </div>
        <div id="engine-info" class="performance-stats">
            エンジン初期化中...
        </div>
    </div>

    <div class="test-container">
        <h2>パフォーマンステスト</h2>
        <button class="test-button" onclick="runBasicPerformanceTest()">基本パフォーマンステスト</button>
        <button class="test-button" onclick="runAdvancedPerformanceTest()">高負荷パフォーマンステスト</button>
        <button class="test-button" onclick="runInputDelayTest()">入力遅延テスト</button>
        <button class="test-button" onclick="clearResults()">結果クリア</button>
        
        <div id="test-results" class="test-results">テスト結果がここに表示されます...</div>
    </div>

    <script type="module">
        // HyperTypingEngineをロード
        import { HyperTypingEngine } from './src/typing/HyperTypingEngine.js';
        
        let engine = null;
        let testResults = [];

        // エンジンを初期化
        async function initializeEngine() {
            try {
                engine = new HyperTypingEngine();
                
                // 初期化状態を確認
                updateOptimizationStatus();
                
                // エンジン情報を表示
                const info = await engine.getEngineInfo();
                document.getElementById('engine-info').innerHTML = `
                    <strong>エンジン情報:</strong><br>
                    Version: ${info.version || 'Unknown'}<br>
                    Phase 1 最適化: ${info.phase1Enabled ? '✅ 有効' : '❌ 無効'}<br>
                    Phase 2 最適化: ${info.phase2Enabled ? '✅ 有効' : '❌ 無効'}<br>
                    WebAssembly: ${info.wasmAvailable ? '✅ 利用可能' : '❌ 利用不可'}<br>
                    初期化時間: ${info.initTime || 'Unknown'}ms
                `;
                
                addResult('✅ HyperTypingEngine初期化完了');
            } catch (error) {
                addResult('❌ エンジン初期化失敗: ' + error.message);
                console.error('Engine initialization failed:', error);
            }
        }

        function updateOptimizationStatus() {
            // Phase 1 ステータス
            const phase1Status = engine?.isPhase1Enabled?.() || false;
            const phase1Element = document.querySelector('.phase-status:nth-child(1)');
            phase1Element.textContent = 'Phase 1: ' + (phase1Status ? '有効' : '無効');
            phase1Element.className = 'phase-status ' + (phase1Status ? 'phase-enabled' : 'phase-disabled');
            
            // Phase 2 ステータス
            const phase2Status = engine?.isPhase2Enabled?.() || false;
            const phase2Element = document.querySelector('.phase-status:nth-child(2)');
            phase2Element.textContent = 'Phase 2: ' + (phase2Status ? '有効' : '無効');
            phase2Element.className = 'phase-status ' + (phase2Status ? 'phase-enabled' : 'phase-disabled');
        }

        function addResult(message) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push(`[${timestamp}] ${message}`);
            document.getElementById('test-results').textContent = testResults.join('\n');
            
            // 自動スクロール
            const resultsElement = document.getElementById('test-results');
            resultsElement.scrollTop = resultsElement.scrollHeight;
        }

        // 基本パフォーマンステスト
        window.runBasicPerformanceTest = async function() {
            if (!engine) {
                addResult('❌ エンジンが初期化されていません');
                return;
            }

            addResult('🧪 基本パフォーマンステスト開始...');
            
            const testCases = [
                'こんにちは',
                'ありがとうございます',
                'プログラミング',
                'コンピュータ',
                'WebAssembly最適化'
            ];

            let totalTime = 0;
            let successCount = 0;

            for (const testCase of testCases) {
                try {
                    const startTime = performance.now();
                    
                    // ひらがなをローマ字に変換
                    const romaji = await engine.convertHiraganaToRomaji(testCase);
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    totalTime += duration;
                    successCount++;
                    
                    addResult(`✅ "${testCase}" -> "${romaji}" (${duration.toFixed(2)}ms)`);
                } catch (error) {
                    addResult(`❌ "${testCase}" 変換失敗: ${error.message}`);
                }
            }

            const averageTime = totalTime / successCount;
            addResult(`📊 基本テスト完了: 平均${averageTime.toFixed(2)}ms (${successCount}/${testCases.length}成功)`);
            
            // パフォーマンス評価
            if (averageTime < 1) {
                addResult('🎉 優秀！ Phase 2 (WebAssembly) レベルの高速化を達成');
            } else if (averageTime < 5) {
                addResult('👍 良好！ Phase 1 (キャッシュ) レベルの高速化を達成');
            } else {
                addResult('⚠️ 改善が必要 - 最適化が無効化されている可能性');
            }
        };

        // 高負荷パフォーマンステスト
        window.runAdvancedPerformanceTest = async function() {
            if (!engine) {
                addResult('❌ エンジンが初期化されていません');
                return;
            }

            addResult('🔥 高負荷パフォーマンステスト開始...');
            
            const iterations = 1000;
            const testString = 'これはパフォーマンステストです';
            
            const startTime = performance.now();
            
            let successCount = 0;
            for (let i = 0; i < iterations; i++) {
                try {
                    await engine.convertHiraganaToRomaji(testString);
                    successCount++;
                } catch (error) {
                    // エラーカウント
                }
            }
            
            const endTime = performance.now();
            const totalTime = endTime - startTime;
            const averageTime = totalTime / iterations;
            const opsPerSecond = 1000 / averageTime;
            
            addResult(`📊 高負荷テスト結果:`);
            addResult(`   総時間: ${totalTime.toFixed(2)}ms`);
            addResult(`   平均時間: ${averageTime.toFixed(3)}ms`);
            addResult(`   処理能力: ${opsPerSecond.toFixed(0)} ops/sec`);
            addResult(`   成功率: ${((successCount / iterations) * 100).toFixed(1)}%`);
            
            // パフォーマンス判定
            if (opsPerSecond > 1000) {
                addResult('🚀 Phase 2 (WebAssembly) レベル: 10-100x高速化達成！');
            } else if (opsPerSecond > 200) {
                addResult('⚡ Phase 1 (キャッシュ) レベル: 2-5x高速化達成！');
            } else {
                addResult('😟 最適化未適用: ベースライン性能');
            }
        };

        // 入力遅延テスト
        window.runInputDelayTest = async function() {
            if (!engine) {
                addResult('❌ エンジンが初期化されていません');
                return;
            }

            addResult('⌨️ 入力遅延テスト開始...');
            
            const inputSequence = 'konnichiha';
            const delays = [];
            
            for (let i = 0; i < inputSequence.length; i++) {
                const char = inputSequence[i];
                const startTime = performance.now();
                
                try {
                    // 文字入力処理をシミュレート
                    await engine.processInput(char);
                    
                    const endTime = performance.now();
                    const delay = endTime - startTime;
                    delays.push(delay);
                    
                    addResult(`⌨️ "${char}" 入力処理: ${delay.toFixed(2)}ms`);
                } catch (error) {
                    addResult(`❌ "${char}" 入力エラー: ${error.message}`);
                }
                
                // 実際のタイピング間隔をシミュレート (100ms)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const averageDelay = delays.reduce((a, b) => a + b, 0) / delays.length;
            const maxDelay = Math.max(...delays);
            
            addResult(`📊 入力遅延テスト結果:`);
            addResult(`   平均遅延: ${averageDelay.toFixed(2)}ms`);
            addResult(`   最大遅延: ${maxDelay.toFixed(2)}ms`);
            
            if (maxDelay < 5) {
                addResult('✅ 優秀！ 入力遅延なし');
            } else if (maxDelay < 20) {
                addResult('👍 良好！ 許容範囲内の遅延');
            } else {
                addResult('⚠️ 改善必要 - 入力遅延が発生');
            }
        };

        window.clearResults = function() {
            testResults = [];
            document.getElementById('test-results').textContent = 'テスト結果がここに表示されます...';
        };

        // 初期化
        initializeEngine();
    </script>
</body>
</html>
