<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ†ã‚¹ãƒˆ</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .typing-area {
      font-size: 1.2rem;
      line-height: 2;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 4px;
      margin: 10px 0;
      min-height: 60px;
      font-family: 'Courier New', monospace;
    }
    
    .typing-char {
      display: inline-block;
      transition: none;
    }
    
    .typing-char.pending {
      color: #888;
    }
    
    .typing-char.current {
      color: #ffffff;
      background: #333;
      border-radius: 2px;
    }
    
    .typing-char.completed {
      color: #4CAF50;
    }
    
    .typing-char.error {
      color: #f44336;
      background: rgba(244, 67, 54, 0.2);
    }
    
    .performance-display {
      background: #0d1b2a;
      border: 1px solid #1b4f72;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    
    .stat-item {
      background: #333;
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #bbb;
      display: block;
    }
    
    .stat-value {
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    .comparison-result {
      background: #2d5016;
      border: 1px solid #4caf50;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    
    .warning {
      background: #5d4037;
      border: 1px solid #ff9800;
      color: #ffcc02;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
    
    .word-display {
      font-size: 1.1rem;
      color: #64b5f6;
      margin: 10px 0;
      padding: 8px;
      background: #1e3a8a;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ†ã‚¹ãƒˆ</h1>
    <p>ç¾åœ¨ã®å®Ÿè£…ã¨PureTypingEngineã®é€Ÿåº¦ã‚’ç›´æ¥æ¯”è¼ƒã—ã¾ã™</p>
    
    <!-- ç´”ç²‹ã‚¨ãƒ³ã‚¸ãƒ³ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h2>ğŸ”¥ PureTypingEngine (typingmania-refæµ)</h2>
      <div class="word-display" id="pure-word-display">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div class="typing-area" id="pure-typing-area"></div>
      <div class="performance-display" id="pure-performance">æ¸¬å®šå¾…æ©Ÿä¸­</div>
      <div class="controls">
        <button onclick="startPureTest()">ç´”ç²‹ã‚¨ãƒ³ã‚¸ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button onclick="resetPureTest()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="simulatePureTyping()">è‡ªå‹•å…¥åŠ›ãƒ†ã‚¹ãƒˆ</button>
      </div>
    </div>
    
    <!-- ç¾åœ¨ã®å®Ÿè£…ã¨ã®æ¯”è¼ƒ -->
    <div class="test-section">
      <h2>ğŸ“Š æ¯”è¼ƒçµæœ</h2>
      <div id="comparison-result" class="warning">
        ã¾ãšç´”ç²‹ã‚¨ãƒ³ã‚¸ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
      </div>
      <div class="controls">
        <button onclick="generateReport()">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
        <button onclick="exportResults()">çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>

  <script>
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    const testWords = [
      { hiragana: 'ã“ã‚“ã«ã¡ã¯', japanese: 'ä»Šæ—¥ã¯' },
      { hiragana: 'ã‚ã‚ŠãŒã¨ã†', japanese: 'ã‚ã‚ŠãŒã¨ã†' },
      { hiragana: 'ãŠã¤ã‹ã‚Œã•ã¾', japanese: 'ãŠç–²ã‚Œæ§˜' },
      { hiragana: 'ãŒã‚“ã°ã£ã¦', japanese: 'é ‘å¼µã£ã¦' },
      { hiragana: 'ã‚ˆã‚ã—ã', japanese: 'ã‚ˆã‚ã—ã' }
    ];
    
    let currentWordIndex = 0;
    let pureEngine = null;
    let pureStats = {
      keyCount: 0,
      correctCount: 0,
      errorCount: 0,
      startTime: 0,
      keyTimes: [],
      latencies: []
    };
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
    class SimpleMeasurer {
      constructor() {
        this.measurements = [];
        this.recording = false;
      }
      
      start() {
        this.measurements = [];
        this.recording = true;
        console.log('ğŸ“Š æ¸¬å®šé–‹å§‹');
      }
      
      recordKeyLatency(latency) {
        if (!this.recording) return;
        this.measurements.push(latency);
      }
      
      stop() {
        this.recording = false;
        return this.getStats();
      }
      
      getStats() {
        if (this.measurements.length === 0) {
          return { count: 0, avg: 0, min: 0, max: 0, acceptable: false };
        }
        
        const avg = this.measurements.reduce((a, b) => a + b, 0) / this.measurements.length;
        const min = Math.min(...this.measurements);
        const max = Math.max(...this.measurements);
        const acceptable = avg <= 5 && max <= 10;
        
        return {
          count: this.measurements.length,
          avg: parseFloat(avg.toFixed(2)),
          min: parseFloat(min.toFixed(2)),
          max: parseFloat(max.toFixed(2)),
          acceptable
        };
      }
    }
    
    const pureMeasurer = new SimpleMeasurer();
    
    // ç°¡æ˜“PureTypingEngineï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    class DemoPureEngine {
      constructor(container) {
        this.container = container;
        this.chars = [];
        this.currentIndex = 0;
        this.keyStartTime = 0;
        this.setupKeyHandler();
      }
      
      setWord(hiragana) {
        // ç°¡æ˜“çš„ãªãƒ­ãƒ¼ãƒå­—å¤‰æ›ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        const romajiMap = {
          'ã“': 'ko', 'ã‚“': 'n', 'ã«': 'ni', 'ã¡': 'ti', 'ã¯': 'ha',
          'ã‚': 'a', 'ã‚Š': 'ri', 'ãŒ': 'ga', 'ã¨': 'to', 'ã†': 'u',
          'ãŠ': 'o', 'ã¤': 'tu', 'ã‹': 'ka', 'ã‚Œ': 're', 'ã•': 'sa', 'ã¾': 'ma',
          'ã°': 'ba', 'ã£': 'tta', 'ã¦': 'te', 'ã‚ˆ': 'yo', 'ã—': 'si', 'ã': 'ku'
        };
        
        this.chars = [];
        for (let char of hiragana) {
          if (romajiMap[char]) {
            this.chars.push({
              kana: char,
              romaji: romajiMap[char],
              inputted: '',
              completed: false
            });
          }
        }
        this.currentIndex = 0;
        this.render();
      }
      
      setupKeyHandler() {
        this.keyHandler = (e) => {
          if (e.key.length !== 1 || !/[a-z]/.test(e.key)) return;
          
          this.keyStartTime = performance.now();
          const result = this.processKey(e.key);
          const endTime = performance.now();
          const latency = endTime - this.keyStartTime;
          
          pureMeasurer.recordKeyLatency(latency);
          this.updateStats(result, latency);
          this.render();
          
          e.preventDefault();
        };
        
        document.addEventListener('keydown', this.keyHandler);
      }
      
      processKey(key) {
        if (this.currentIndex >= this.chars.length) return 'completed';
        
        const currentChar = this.chars[this.currentIndex];
        const expectedChar = currentChar.romaji[currentChar.inputted.length];
        
        if (key === expectedChar) {
          currentChar.inputted += key;
          if (currentChar.inputted === currentChar.romaji) {
            currentChar.completed = true;
            this.currentIndex++;
          }
          return 'correct';
        } else {
          return 'error';
        }
      }
      
      updateStats(result, latency) {
        pureStats.keyCount++;
        if (result === 'correct') {
          pureStats.correctCount++;
        } else if (result === 'error') {
          pureStats.errorCount++;
        }
        pureStats.latencies.push(latency);
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºæ›´æ–°
        this.updatePerformanceDisplay();
      }
      
      updatePerformanceDisplay() {
        const stats = pureMeasurer.getStats();
        const accuracy = pureStats.keyCount > 0 ? (pureStats.correctCount / pureStats.keyCount * 100).toFixed(1) : 0;
        
        document.getElementById('pure-performance').innerHTML = `
          <div class="stats">
            <div class="stat-item">
              <span class="stat-label">å¹³å‡é…å»¶</span>
              <span class="stat-value" style="color: ${stats.avg <= 5 ? '#4CAF50' : '#ff9800'}">${stats.avg}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æœ€å¤§é…å»¶</span>
              <span class="stat-value" style="color: ${stats.max <= 10 ? '#4CAF50' : '#f44336'}">${stats.max}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æ­£ç¢ºç‡</span>
              <span class="stat-value">${accuracy}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ã‚­ãƒ¼æ•°</span>
              <span class="stat-value">${pureStats.keyCount}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">typingmania-refç›®æ¨™</span>
              <span class="stat-value" style="color: ${stats.acceptable ? '#4CAF50' : '#f44336'}">${stats.acceptable ? 'âœ… é”æˆ' : 'âŒ æœªé”æˆ'}</span>
            </div>
          </div>
        `;
      }
      
      render() {
        const html = this.chars.map((char, index) => {
          let displayChars = '';
          for (let i = 0; i < char.romaji.length; i++) {
            const romChar = char.romaji[i];
            let className = 'typing-char ';
            
            if (i < char.inputted.length) {
              className += 'completed';
            } else if (index === this.currentIndex && i === char.inputted.length) {
              className += 'current';
            } else {
              className += 'pending';
            }
            
            displayChars += `<span class="${className}">${romChar}</span>`;
          }
          return displayChars;
        }).join('');
        
        this.container.innerHTML = html;
      }
      
      destroy() {
        if (this.keyHandler) {
          document.removeEventListener('keydown', this.keyHandler);
        }
      }
      
      isCompleted() {
        return this.currentIndex >= this.chars.length;
      }
    }
    
    // ãƒ†ã‚¹ãƒˆåˆ¶å¾¡é–¢æ•°
    function startPureTest() {
      if (pureEngine) {
        pureEngine.destroy();
      }
      
      // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
      pureStats = {
        keyCount: 0,
        correctCount: 0,
        errorCount: 0,
        startTime: performance.now(),
        keyTimes: [],
        latencies: []
      };
      
      pureMeasurer.start();
      
      const container = document.getElementById('pure-typing-area');
      pureEngine = new DemoPureEngine(container);
      
      currentWordIndex = 0;
      const word = testWords[currentWordIndex];
      document.getElementById('pure-word-display').textContent = word.japanese + ' (' + word.hiragana + ')';
      pureEngine.setWord(word.hiragana);
      
      document.getElementById('pure-performance').innerHTML = '<p>ğŸ“Š æ¸¬å®šä¸­... ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>';
    }
    
    function resetPureTest() {
      if (pureEngine) {
        pureEngine.destroy();
        pureEngine = null;
      }
      pureMeasurer.stop();
      document.getElementById('pure-typing-area').innerHTML = '';
      document.getElementById('pure-performance').innerHTML = 'æ¸¬å®šå¾…æ©Ÿä¸­';
      document.getElementById('pure-word-display').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    }
    
    function simulatePureTyping() {
      if (!pureEngine) {
        startPureTest();
        setTimeout(simulatePureTyping, 100);
        return;
      }
      
      // ã“ã‚“ã«ã¡ã¯ã®è‡ªå‹•å…¥åŠ›
      const keys = ['k', 'o', 'n', 'n', 'i', 't', 'i', 'h', 'a'];
      let keyIndex = 0;
      
      const simulate = () => {
        if (keyIndex >= keys.length || pureEngine.isCompleted()) {
          setTimeout(() => {
            const stats = pureMeasurer.stop();
            showComparisonResult(stats);
          }, 500);
          return;
        }
        
        const key = keys[keyIndex];
        const event = new KeyboardEvent('keydown', {
          key: key,
          bubbles: true,
          cancelable: true
        });
        
        document.dispatchEvent(event);
        keyIndex++;
        
        setTimeout(simulate, 50 + Math.random() * 100); // ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”
      };
      
      setTimeout(simulate, 500);
    }
    
    function showComparisonResult(pureStats) {
      const resultDiv = document.getElementById('comparison-result');
      
      if (pureStats.acceptable) {
        resultDiv.className = 'comparison-result';
        resultDiv.innerHTML = `
          <h3>ğŸš€ PureTypingEngine çµæœ</h3>
          <p><strong>å¹³å‡é…å»¶:</strong> ${pureStats.avg}ms (ç›®æ¨™: â‰¤5ms)</p>
          <p><strong>æœ€å¤§é…å»¶:</strong> ${pureStats.max}ms (ç›®æ¨™: â‰¤10ms)</p>
          <p><strong>æ¸¬å®šå›æ•°:</strong> ${pureStats.count}å›</p>
          <p><strong>ç›®æ¨™é”æˆ:</strong> âœ… typingmania-refãƒ¬ãƒ™ãƒ«ã‚’é”æˆ</p>
          <p>ã“ã®ç´”ç²‹ã‚¨ãƒ³ã‚¸ãƒ³ã¯ååˆ†é«˜é€Ÿã§ã™ã€‚ç¾åœ¨ã®å®Ÿè£…ã¨ç½®ãæ›ãˆã‚‹ã“ã¨ã§å¤§å¹…ãªé€Ÿåº¦å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚</p>
        `;
      } else {
        resultDiv.className = 'warning';
        resultDiv.innerHTML = `
          <h3>âš ï¸ PureTypingEngine çµæœ</h3>
          <p><strong>å¹³å‡é…å»¶:</strong> ${pureStats.avg}ms (ç›®æ¨™: â‰¤5ms)</p>
          <p><strong>æœ€å¤§é…å»¶:</strong> ${pureStats.max}ms (ç›®æ¨™: â‰¤10ms)</p>
          <p><strong>æ¸¬å®šå›æ•°:</strong> ${pureStats.count}å›</p>
          <p><strong>ç›®æ¨™é”æˆ:</strong> âŒ ã•ã‚‰ãªã‚‹æœ€é©åŒ–ãŒå¿…è¦</p>
        `;
      }
    }
    
    function generateReport() {
      const stats = pureMeasurer.getStats();
      const report = {
        timestamp: new Date().toISOString(),
        pureEngine: stats,
        environment: {
          userAgent: navigator.userAgent,
          platform: navigator.platform
        }
      };
      
      console.log('ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ:', report);
      alert('è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸ');
    }
    
    function exportResults() {
      const stats = pureMeasurer.getStats();
      const data = {
        testType: 'PureTypingEngine Performance Test',
        timestamp: new Date().toISOString(),
        results: stats,
        latencies: pureStats.latencies
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'typing-performance-test.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // åˆæœŸåŒ–
    window.addEventListener('load', () => {
      console.log('ğŸš€ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†');
      document.getElementById('pure-word-display').textContent = 'ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
    });
  </script>
</body>
</html>
