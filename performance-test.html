<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイピングパフォーマンス比較テスト</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .typing-area {
      font-size: 1.2rem;
      line-height: 2;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 4px;
      margin: 10px 0;
      min-height: 60px;
      font-family: 'Courier New', monospace;
    }
    
    .typing-char {
      display: inline-block;
      transition: none;
    }
    
    .typing-char.pending {
      color: #888;
    }
    
    .typing-char.current {
      color: #ffffff;
      background: #333;
      border-radius: 2px;
    }
    
    .typing-char.completed {
      color: #4CAF50;
    }
    
    .typing-char.error {
      color: #f44336;
      background: rgba(244, 67, 54, 0.2);
    }
    
    .performance-display {
      background: #0d1b2a;
      border: 1px solid #1b4f72;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    
    .stat-item {
      background: #333;
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #bbb;
      display: block;
    }
    
    .stat-value {
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    .comparison-result {
      background: #2d5016;
      border: 1px solid #4caf50;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    
    .warning {
      background: #5d4037;
      border: 1px solid #ff9800;
      color: #ffcc02;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
    
    .word-display {
      font-size: 1.1rem;
      color: #64b5f6;
      margin: 10px 0;
      padding: 8px;
      background: #1e3a8a;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 タイピングパフォーマンス比較テスト</h1>
    <p>現在の実装とPureTypingEngineの速度を直接比較します</p>
    
    <!-- 純粋エンジンテスト -->
    <div class="test-section">
      <h2>🔥 PureTypingEngine (typingmania-ref流)</h2>
      <div class="word-display" id="pure-word-display">読み込み中...</div>
      <div class="typing-area" id="pure-typing-area"></div>
      <div class="performance-display" id="pure-performance">測定待機中</div>
      <div class="controls">
        <button onclick="startPureTest()">純粋エンジンテスト開始</button>
        <button onclick="resetPureTest()">リセット</button>
        <button onclick="simulatePureTyping()">自動入力テスト</button>
      </div>
    </div>
    
    <!-- 現在の実装との比較 -->
    <div class="test-section">
      <h2>📊 比較結果</h2>
      <div id="comparison-result" class="warning">
        まず純粋エンジンでテストを実行してください
      </div>
      <div class="controls">
        <button onclick="generateReport()">詳細レポート生成</button>
        <button onclick="exportResults()">結果をエクスポート</button>
      </div>
    </div>
  </div>

  <script>
    // テストデータ
    const testWords = [
      { hiragana: 'こんにちは', japanese: '今日は' },
      { hiragana: 'ありがとう', japanese: 'ありがとう' },
      { hiragana: 'おつかれさま', japanese: 'お疲れ様' },
      { hiragana: 'がんばって', japanese: '頑張って' },
      { hiragana: 'よろしく', japanese: 'よろしく' }
    ];
    
    let currentWordIndex = 0;
    let pureEngine = null;
    let pureStats = {
      keyCount: 0,
      correctCount: 0,
      errorCount: 0,
      startTime: 0,
      keyTimes: [],
      latencies: []
    };
    
    // パフォーマンス測定
    class SimpleMeasurer {
      constructor() {
        this.measurements = [];
        this.recording = false;
      }
      
      start() {
        this.measurements = [];
        this.recording = true;
        console.log('📊 測定開始');
      }
      
      recordKeyLatency(latency) {
        if (!this.recording) return;
        this.measurements.push(latency);
      }
      
      stop() {
        this.recording = false;
        return this.getStats();
      }
      
      getStats() {
        if (this.measurements.length === 0) {
          return { count: 0, avg: 0, min: 0, max: 0, acceptable: false };
        }
        
        const avg = this.measurements.reduce((a, b) => a + b, 0) / this.measurements.length;
        const min = Math.min(...this.measurements);
        const max = Math.max(...this.measurements);
        const acceptable = avg <= 5 && max <= 10;
        
        return {
          count: this.measurements.length,
          avg: parseFloat(avg.toFixed(2)),
          min: parseFloat(min.toFixed(2)),
          max: parseFloat(max.toFixed(2)),
          acceptable
        };
      }
    }
    
    const pureMeasurer = new SimpleMeasurer();
    
    // 簡易PureTypingEngine（デモ用）
    class DemoPureEngine {
      constructor(container) {
        this.container = container;
        this.chars = [];
        this.currentIndex = 0;
        this.keyStartTime = 0;
        this.setupKeyHandler();
      }
      
      setWord(hiragana) {
        // 簡易的なローマ字変換（デモ用）
        const romajiMap = {
          'こ': 'ko', 'ん': 'n', 'に': 'ni', 'ち': 'ti', 'は': 'ha',
          'あ': 'a', 'り': 'ri', 'が': 'ga', 'と': 'to', 'う': 'u',
          'お': 'o', 'つ': 'tu', 'か': 'ka', 'れ': 're', 'さ': 'sa', 'ま': 'ma',
          'ば': 'ba', 'っ': 'tta', 'て': 'te', 'よ': 'yo', 'し': 'si', 'く': 'ku'
        };
        
        this.chars = [];
        for (let char of hiragana) {
          if (romajiMap[char]) {
            this.chars.push({
              kana: char,
              romaji: romajiMap[char],
              inputted: '',
              completed: false
            });
          }
        }
        this.currentIndex = 0;
        this.render();
      }
      
      setupKeyHandler() {
        this.keyHandler = (e) => {
          if (e.key.length !== 1 || !/[a-z]/.test(e.key)) return;
          
          this.keyStartTime = performance.now();
          const result = this.processKey(e.key);
          const endTime = performance.now();
          const latency = endTime - this.keyStartTime;
          
          pureMeasurer.recordKeyLatency(latency);
          this.updateStats(result, latency);
          this.render();
          
          e.preventDefault();
        };
        
        document.addEventListener('keydown', this.keyHandler);
      }
      
      processKey(key) {
        if (this.currentIndex >= this.chars.length) return 'completed';
        
        const currentChar = this.chars[this.currentIndex];
        const expectedChar = currentChar.romaji[currentChar.inputted.length];
        
        if (key === expectedChar) {
          currentChar.inputted += key;
          if (currentChar.inputted === currentChar.romaji) {
            currentChar.completed = true;
            this.currentIndex++;
          }
          return 'correct';
        } else {
          return 'error';
        }
      }
      
      updateStats(result, latency) {
        pureStats.keyCount++;
        if (result === 'correct') {
          pureStats.correctCount++;
        } else if (result === 'error') {
          pureStats.errorCount++;
        }
        pureStats.latencies.push(latency);
        
        // リアルタイム表示更新
        this.updatePerformanceDisplay();
      }
      
      updatePerformanceDisplay() {
        const stats = pureMeasurer.getStats();
        const accuracy = pureStats.keyCount > 0 ? (pureStats.correctCount / pureStats.keyCount * 100).toFixed(1) : 0;
        
        document.getElementById('pure-performance').innerHTML = `
          <div class="stats">
            <div class="stat-item">
              <span class="stat-label">平均遅延</span>
              <span class="stat-value" style="color: ${stats.avg <= 5 ? '#4CAF50' : '#ff9800'}">${stats.avg}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">最大遅延</span>
              <span class="stat-value" style="color: ${stats.max <= 10 ? '#4CAF50' : '#f44336'}">${stats.max}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">正確率</span>
              <span class="stat-value">${accuracy}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">キー数</span>
              <span class="stat-value">${pureStats.keyCount}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">typingmania-ref目標</span>
              <span class="stat-value" style="color: ${stats.acceptable ? '#4CAF50' : '#f44336'}">${stats.acceptable ? '✅ 達成' : '❌ 未達成'}</span>
            </div>
          </div>
        `;
      }
      
      render() {
        const html = this.chars.map((char, index) => {
          let displayChars = '';
          for (let i = 0; i < char.romaji.length; i++) {
            const romChar = char.romaji[i];
            let className = 'typing-char ';
            
            if (i < char.inputted.length) {
              className += 'completed';
            } else if (index === this.currentIndex && i === char.inputted.length) {
              className += 'current';
            } else {
              className += 'pending';
            }
            
            displayChars += `<span class="${className}">${romChar}</span>`;
          }
          return displayChars;
        }).join('');
        
        this.container.innerHTML = html;
      }
      
      destroy() {
        if (this.keyHandler) {
          document.removeEventListener('keydown', this.keyHandler);
        }
      }
      
      isCompleted() {
        return this.currentIndex >= this.chars.length;
      }
    }
    
    // テスト制御関数
    function startPureTest() {
      if (pureEngine) {
        pureEngine.destroy();
      }
      
      // 統計リセット
      pureStats = {
        keyCount: 0,
        correctCount: 0,
        errorCount: 0,
        startTime: performance.now(),
        keyTimes: [],
        latencies: []
      };
      
      pureMeasurer.start();
      
      const container = document.getElementById('pure-typing-area');
      pureEngine = new DemoPureEngine(container);
      
      currentWordIndex = 0;
      const word = testWords[currentWordIndex];
      document.getElementById('pure-word-display').textContent = word.japanese + ' (' + word.hiragana + ')';
      pureEngine.setWord(word.hiragana);
      
      document.getElementById('pure-performance').innerHTML = '<p>📊 測定中... タイピングを開始してください</p>';
    }
    
    function resetPureTest() {
      if (pureEngine) {
        pureEngine.destroy();
        pureEngine = null;
      }
      pureMeasurer.stop();
      document.getElementById('pure-typing-area').innerHTML = '';
      document.getElementById('pure-performance').innerHTML = '測定待機中';
      document.getElementById('pure-word-display').textContent = '読み込み中...';
    }
    
    function simulatePureTyping() {
      if (!pureEngine) {
        startPureTest();
        setTimeout(simulatePureTyping, 100);
        return;
      }
      
      // こんにちはの自動入力
      const keys = ['k', 'o', 'n', 'n', 'i', 't', 'i', 'h', 'a'];
      let keyIndex = 0;
      
      const simulate = () => {
        if (keyIndex >= keys.length || pureEngine.isCompleted()) {
          setTimeout(() => {
            const stats = pureMeasurer.stop();
            showComparisonResult(stats);
          }, 500);
          return;
        }
        
        const key = keys[keyIndex];
        const event = new KeyboardEvent('keydown', {
          key: key,
          bubbles: true,
          cancelable: true
        });
        
        document.dispatchEvent(event);
        keyIndex++;
        
        setTimeout(simulate, 50 + Math.random() * 100); // ランダムな間隔
      };
      
      setTimeout(simulate, 500);
    }
    
    function showComparisonResult(pureStats) {
      const resultDiv = document.getElementById('comparison-result');
      
      if (pureStats.acceptable) {
        resultDiv.className = 'comparison-result';
        resultDiv.innerHTML = `
          <h3>🚀 PureTypingEngine 結果</h3>
          <p><strong>平均遅延:</strong> ${pureStats.avg}ms (目標: ≤5ms)</p>
          <p><strong>最大遅延:</strong> ${pureStats.max}ms (目標: ≤10ms)</p>
          <p><strong>測定回数:</strong> ${pureStats.count}回</p>
          <p><strong>目標達成:</strong> ✅ typingmania-refレベルを達成</p>
          <p>この純粋エンジンは十分高速です。現在の実装と置き換えることで大幅な速度向上が期待できます。</p>
        `;
      } else {
        resultDiv.className = 'warning';
        resultDiv.innerHTML = `
          <h3>⚠️ PureTypingEngine 結果</h3>
          <p><strong>平均遅延:</strong> ${pureStats.avg}ms (目標: ≤5ms)</p>
          <p><strong>最大遅延:</strong> ${pureStats.max}ms (目標: ≤10ms)</p>
          <p><strong>測定回数:</strong> ${pureStats.count}回</p>
          <p><strong>目標達成:</strong> ❌ さらなる最適化が必要</p>
        `;
      }
    }
    
    function generateReport() {
      const stats = pureMeasurer.getStats();
      const report = {
        timestamp: new Date().toISOString(),
        pureEngine: stats,
        environment: {
          userAgent: navigator.userAgent,
          platform: navigator.platform
        }
      };
      
      console.log('📋 詳細レポート:', report);
      alert('詳細レポートがコンソールに出力されました');
    }
    
    function exportResults() {
      const stats = pureMeasurer.getStats();
      const data = {
        testType: 'PureTypingEngine Performance Test',
        timestamp: new Date().toISOString(),
        results: stats,
        latencies: pureStats.latencies
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'typing-performance-test.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // 初期化
    window.addEventListener('load', () => {
      console.log('🚀 タイピングパフォーマンステスト準備完了');
      document.getElementById('pure-word-display').textContent = 'テスト開始ボタンを押してください';
    });
  </script>
</body>
</html>
